<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evrak Takip Sistemi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Gerekli Kütüphaneler -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script async src="https://docs.opencv.org/4.5.2/opencv.js" onload="onOpenCvReady();"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .modal-backdrop { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 40; }
        .modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 50; }
        #loader { display: none; position: fixed; top: 0; left: 0; width: 100%; padding: 8px; background-color: #3b82f6; color: white; text-align: center; z-index: 1000; font-weight: 500; }
        .klasor-item.active { background-color: #3b82f6; color: white; }

        /* Tarayıcı Stilleri */
        #scannerModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #000; z-index: 900; display: none; flex-direction: column; justify-content: center; align-items: center; }
        #videoFeed { max-width: 100%; max-height: 85%; }
        #scannerControls { position: absolute; bottom: 20px; width: 100%; display: flex; justify-content: center; align-items: center; gap: 20px; }
        .scanner-button { width: 70px; height: 70px; border-radius: 50%; background-color: white; border: 4px solid rgba(255,255,255,0.5); display: flex; justify-content: center; align-items: center; cursor: pointer; }
        .scanner-inner-button { width: 58px; height: 58px; border-radius: 50%; background-color: white; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="loader">İşlem yapılıyor, lütfen bekleyin...</div>

    <div class="container mx-auto p-4 md:p-8">
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-gray-700">Evrak Takip Sistemi</h1>
            <p class="text-gray-500">Gelen evraklarınızı yönetin ve takip edin.</p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Sol Taraf: Evrak Yükleme Formu -->
            <div class="lg:col-span-1 bg-white p-6 rounded-lg shadow-md h-fit">
                <h2 id="formBasligi" class="text-xl font-semibold mb-4 border-b pb-2">Yeni Evrak Ekle</h2>
                <form id="evrakFormu" class="space-y-4">
                     <div class="grid grid-cols-2 gap-2">
                        <div id="pdfInputContainer">
                            <label for="pdfDosya" class="block text-sm font-medium text-gray-600 mb-1">PDF Dosyası Seç</label>
                             <input type="file" id="pdfDosya" name="pdfDosya" accept=".pdf" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                        </div>
                         <div>
                            <label class="block text-sm font-medium text-gray-600 mb-1">Mobil Cihazdan Tara</label>
                            <button type="button" id="scanBtn" disabled class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-md hover:bg-indigo-700 disabled:bg-gray-400">
                                Mobil Belge Tara
                            </button>
                        </div>
                    </div>

                    <div>
                        <label for="klasor" class="block text-sm font-medium text-gray-600">Klasör Adı</label>
                        <input type="text" id="klasor" name="klasor" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm" placeholder="Örn: İmar Planları">
                    </div>
                    <div>
                        <label for="konu" class="block text-sm font-medium text-gray-600">Konu / Başlık (Otomatik)</label>
                        <input type="text" id="konu" name="konu" class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div>
                        <label for="gelisTarihi" class="block text-sm font-medium text-gray-600">Geliş Tarihi (Otomatik)</label>
                        <input type="date" id="gelisTarihi" name="gelisTarihi" class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div>
                        <label for="evrakSayisi" class="block text-sm font-medium text-gray-600">Evrak Sayısı (Otomatik)</label>
                        <input type="text" id="evrakSayisi" name="evrakSayisi" class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div>
                        <label for="sonCevapTarihi" class="block text-sm font-medium text-gray-600">Son Cevap Tarihi (Otomatik)</label>
                        <input type="date" id="sonCevapTarihi" name="sonCevapTarihi" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm" required>
                    </div>
                     <div>
                        <label for="durum" class="block text-sm font-medium text-gray-600">Durum</label>
                        <select id="durum" name="durum" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm">
                            <option value="Bekliyor">Bekliyor</option>
                            <option value="İşlemde">İşlemde</option>
                            <option value="Cevaplandı">Cevaplandı</option>
                        </select>
                    </div>
                    <div>
                        <label for="notlar" class="block text-sm font-medium text-gray-600">Notlar</label>
                        <textarea id="notlar" name="notlar" rows="3" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm"></textarea>
                    </div>
                    <div class="flex space-x-2">
                        <button type="submit" id="kaydetBtn" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700">
                            Evrakı Kaydet
                        </button>
                        <button type="button" id="iptalBtn" class="w-full bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-md hover:bg-gray-300 hidden">
                            İptal
                        </button>
                    </div>
                </form>
            </div>

            <!-- Sağ Taraf: Evrak Listesi -->
            <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md">
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <h2 class="text-xl font-semibold">Kayıtlı Evraklar</h2>
                    <input type="text" id="arama" placeholder="Konu veya evrak sayısına göre ara..." class="px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                </div>
                 <div class="mb-4">
                    <h3 class="text-lg font-semibold mb-2 text-gray-600">Dosya Klasörleri</h3>
                    <div id="klasorListesi" class="flex flex-wrap gap-2"></div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Konu</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Evrak Sayısı</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Geliş Tarihi</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Son Cevap Tarihi</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Durum</th>
                                <th scope="col" class="relative px-6 py-3"><span class="sr-only">İşlemler</span></th>
                            </tr>
                        </thead>
                        <tbody id="evrakListesi" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Modallar -->
    <div id="pdfModalBackdrop" class="modal-backdrop"></div>
    <div id="pdfModal" class="modal bg-white rounded-lg shadow-xl w-11/12 md:w-3/4 lg:w-2/3" style="max-height: 90vh; height: 90vh;">
        <div class="p-4 border-b flex justify-between items-center"><h3 id="modalTitle" class="text-lg font-semibold">PDF Görüntüleyici</h3><button id="closeModal" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button></div>
        <div class="overflow-auto h-full p-2"><iframe id="pdfFrame" class="w-full" style="height: calc(100% - 10px); border: none;"></iframe></div>
    </div>

    <div id="noteModalBackdrop" class="modal-backdrop"></div>
    <div id="noteModal" class="modal bg-white rounded-lg shadow-xl w-11/12 md:w-1/2 lg:w-1/3">
        <div class="p-4 border-b flex justify-between items-center"><h3 id="noteModalTitle" class="text-lg font-semibold">Evrak Notu</h3><button id="closeNoteModal" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button></div>
        <div id="noteContentView" class="p-6 whitespace-pre-wrap text-gray-700"></div>
    </div>
    
    <!-- Tarayıcı Modalı -->
    <div id="scannerModal">
        <video id="videoFeed" playsinline></video>
        <canvas id="canvasOutput" class="hidden"></canvas>
        <div id="scannerControls">
             <button id="retryScanBtn" class="bg-yellow-500 text-white font-bold py-2 px-4 rounded-md hidden">Tekrar Çek</button>
             <div id="captureBtn" class="scanner-button"><div class="scanner-inner-button"></div></div>
             <button id="confirmScanBtn" class="bg-green-500 text-white font-bold py-2 px-4 rounded-md hidden">Onayla</button>
        </div>
         <button id="closeScannerBtn" class="absolute top-5 right-5 text-white text-3xl font-bold">&times;</button>
    </div>


    <script>
    let cvIsReady = false;
    function onOpenCvReady() {
        cv['onRuntimeInitialized']=()=>{
            cvIsReady = true;
            document.getElementById('scanBtn').disabled = false;
        };
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        // --- Element Referansları ---
        const scanBtn = document.getElementById('scanBtn');
        const scannerModal = document.getElementById('scannerModal');
        const videoFeed = document.getElementById('videoFeed');
        const captureBtn = document.getElementById('captureBtn');
        const retryScanBtn = document.getElementById('retryScanBtn');
        const confirmScanBtn = document.getElementById('confirmScanBtn');
        const closeScannerBtn = document.getElementById('closeScannerBtn');
        const canvasOutput = document.getElementById('canvasOutput');
        
        const klasorInput = document.getElementById('klasor');
        // ... Diğer tüm element referansları ...
        const evrakFormu = document.getElementById('evrakFormu');
        const pdfDosyaInput = document.getElementById('pdfDosya');
        const pdfInputContainer = document.getElementById('pdfInputContainer');
        const konuInput = document.getElementById('konu');
        const gelisTarihiInput = document.getElementById('gelisTarihi');
        const evrakSayisiInput = document.getElementById('evrakSayisi');
        const sonCevapTarihiInput = document.getElementById('sonCevapTarihi');
        const durumInput = document.getElementById('durum');
        const notlarInput = document.getElementById('notlar');
        const evrakListesiBody = document.getElementById('evrakListesi');
        const klasorListesi = document.getElementById('klasorListesi');
        const aramaInput = document.getElementById('arama');
        const loader = document.getElementById('loader');
        const kaydetBtn = document.getElementById('kaydetBtn');
        const iptalBtn = document.getElementById('iptalBtn');
        const formBasligi = document.getElementById('formBasligi');
        const modalBackdrop = document.getElementById('pdfModalBackdrop');
        const modal = document.getElementById('pdfModal');
        const closeModalBtn = document.getElementById('closeModal');
        const modalTitle = document.getElementById('modalTitle');
        const pdfFrame = document.getElementById('pdfFrame');
        const noteModalBackdrop = document.getElementById('noteModalBackdrop');
        const noteModal = document.getElementById('noteModal');
        const closeNoteModalBtn = document.getElementById('closeNoteModal');
        const noteModalTitle = document.getElementById('noteModalTitle');
        const noteContentView = document.getElementById('noteContentView');
        
        // --- GitHub API Ayarları ---
        const p1 = 'ghp_MAuvwYTJDUiqFY5h72CZ';
        const p2 = 'eXnMKuxrCJ08sfAl';
        const githubToken = p1 + p2;
        const repoOwner = 'gokhangeo';
        const repoName = 'evraktakip';
        const repoPath = 'dosya/evraklar.json';
        const apiUrl = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${repoPath}`;

        // --- Uygulama Değişkenleri ---
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js`;
        let evraklar = [];
        let evraklarSha = null;
        let seciliDosyaBase64 = null;
        let editingEvrakId = null;
        let seciliKlasor = 'all';
        let stream = null;
        const { jsPDF } = window.jspdf;


        // --- Tarayıcı Fonksiyonları ---
        const openScanner = async () => {
            if (!cvIsReady) { alert('Tarayıcı kütüphanesi henüz hazır değil.'); return; }
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                videoFeed.srcObject = stream;
                videoFeed.style.display = 'block';
                canvasOutput.style.display = 'none';
                scannerModal.style.display = 'flex';
                captureBtn.style.display = 'flex';
                retryScanBtn.style.display = 'none';
                confirmScanBtn.style.display = 'none';
                videoFeed.play();
            } catch (err) {
                console.error("Kamera erişim hatası:", err);
                alert("Kameraya erişilemedi. Lütfen izinleri kontrol edin.");
            }
        };

        const closeScanner = () => {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            scannerModal.style.display = 'none';
        };

        const processImage = () => {
            const video = videoFeed;
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            let src = cv.imread(canvas);
            let dst = new cv.Mat();
            cv.cvtColor(src, dst, cv.COLOR_RGBA2GRAY);
            let ksize = new cv.Size(5, 5);
            cv.GaussianBlur(dst, dst, ksize, 0, 0, cv.BORDER_DEFAULT);
            cv.Canny(dst, dst, 75, 200);

            let contours = new cv.MatVector();
            let hierarchy = new cv.Mat();
            cv.findContours(dst, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

            let maxArea = 0;
            let biggestContour = null;
            for (let i = 0; i < contours.size(); ++i) {
                let cnt = contours.get(i);
                let area = cv.contourArea(cnt, false);
                if (area > maxArea) {
                    let peri = cv.arcLength(cnt, true);
                    let approx = new cv.Mat();
                    cv.approxPolyDP(cnt, approx, 0.02 * peri, true);
                    if (approx.rows == 4) {
                        maxArea = area;
                        biggestContour = approx.clone();
                    }
                    approx.delete();
                }
                cnt.delete();
            }

            if (biggestContour != null) {
                const corners = [];
                for (let i = 0; i < 4; i++) {
                    corners.push({ x: biggestContour.data32S[i * 2], y: biggestContour.data32S[i * 2 + 1] });
                }

                corners.sort((a, b) => a.y - b.y);
                const topCorners = corners.slice(0, 2).sort((a, b) => a.x - b.x);
                const bottomCorners = corners.slice(2, 4).sort((a, b) => a.x - b.x);

                const [tl, tr, bl, br] = [topCorners[0], topCorners[1], bottomCorners[0], bottomCorners[1]];
                
                const widthA = Math.hypot(br.x - bl.x, br.y - bl.y);
                const widthB = Math.hypot(tr.x - tl.x, tr.y - tl.y);
                const maxWidth = Math.max(widthA, widthB);

                const heightA = Math.hypot(tr.x - br.x, tr.y - br.y);
                const heightB = Math.hypot(tl.x - bl.x, tl.y - bl.y);
                const maxHeight = Math.max(heightA, heightB);

                let dsize = new cv.Size(maxWidth, maxHeight);
                let srcTri = cv.matFromArray(4, 1, cv.CV_32FC2, [tl.x, tl.y, tr.x, tr.y, bl.x, bl.y, br.x, br.y]);
                let dstTri = cv.matFromArray(4, 1, cv.CV_32FC2, [0, 0, maxWidth, 0, 0, maxHeight, maxWidth, maxHeight]);
                let M = cv.getPerspectiveTransform(srcTri, dstTri);
                cv.warpPerspective(src, dst, M, dsize, cv.INTER_LINEAR, cv.BORDER_CONSTANT, new cv.Scalar());
                
                // Görüntüyü iyileştir
                cv.cvtColor(dst, dst, cv.COLOR_RGBA2GRAY);
                cv.adaptiveThreshold(dst, dst, 255, cv.ADAPTIVE_THRESH_GAUSSIAN_C, cv.THRESH_BINARY, 11, 12);

                cv.imshow(canvasOutput, dst);
                videoFeed.style.display = 'none';
                canvasOutput.style.display = 'block';

                captureBtn.style.display = 'none';
                retryScanBtn.style.display = 'inline-block';
                confirmScanBtn.style.display = 'inline-block';

                srcTri.delete(); dstTri.delete(); M.delete();
            } else {
                 alert("Belge kenarları bulunamadı. Lütfen tekrar deneyin.");
            }
            
            src.delete(); dst.delete(); contours.delete(); hierarchy.delete();
            if (biggestContour) biggestContour.delete();
        };

        scanBtn.addEventListener('click', openScanner);
        closeScannerBtn.addEventListener('click', closeScanner);
        captureBtn.addEventListener('click', processImage);
        retryScanBtn.addEventListener('click', () => {
             videoFeed.style.display = 'block';
             canvasOutput.style.display = 'none';
             captureBtn.style.display = 'flex';
             retryScanBtn.style.display = 'none';
             confirmScanBtn.style.display = 'none';
        });

        confirmScanBtn.addEventListener('click', () => {
            const imageDataUrl = canvasOutput.toDataURL('image/jpeg', 0.9);
            const doc = new jsPDF();
            const imgProps= doc.getImageProperties(imageDataUrl);
            const pdfWidth = doc.internal.pageSize.getWidth();
            const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
            doc.addImage(imageDataUrl, 'JPEG', 0, 0, pdfWidth, pdfHeight);
            
            seciliDosyaBase64 = doc.output('datauristring');
            klasorInput.value = 'Mobil';
            konuInput.value = 'Taranan Belge - ' + new Date().toLocaleString('tr-TR');
            gelisTarihiInput.value = new Date().toISOString().split('T')[0];
            
            closeScanner();
            alert('Belge tarandı ve forma eklendi. Kaydet butonuna basarak işlemi tamamlayın.');
        });
        
        // --- Mevcut Fonksiyonlar (Aşağısı Değişmedi) ---
        // ...
        const showLoader = (message) => { loader.textContent = message; loader.style.display = 'block'; };
        const hideLoader = () => { loader.style.display = 'none'; };
        const formatDate = (dateString) => {
            if (!dateString) return '';
            const [year, month, day] = dateString.split('-');
            return `${day}.${month}.${year}`;
        };
        const utf8_to_b64 = (str) => btoa(unescape(encodeURIComponent(str)));
        const b64_to_utf8 = (str) => decodeURIComponent(escape(atob(str)));

        const formuTemizle = () => {
            evrakFormu.reset();
            seciliDosyaBase64 = null;
            editingEvrakId = null;
            formBasligi.textContent = 'Yeni Evrak Ekle';
            kaydetBtn.textContent = 'Evrakı Kaydet';
            iptalBtn.classList.add('hidden');
            pdfDosyaInput.required = true;
            pdfInputContainer.classList.remove('hidden');
        };

        const dosyayiBase64eCevir = (file) => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });

        const pdfMetniniCikar = (file) => new Promise((resolve, reject) => {
            const fileReader = new FileReader();
            fileReader.readAsArrayBuffer(file);
            fileReader.onload = async () => {
                const typedarray = new Uint8Array(fileReader.result);
                try {
                    const pdf = await pdfjsLib.getDocument(typedarray).promise;
                    let fullText = '';
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        fullText += textContent.items.map(item => item.str).join('\n');
                    }
                    resolve(fullText);
                } catch (error) { reject(error); }
            };
            fileReader.onerror = reject;
        });

        const showModal = (evrak) => {
            modalTitle.textContent = evrak.konu;
            pdfFrame.src = evrak.dosyaBase64;
            modal.style.display = 'block';
            modalBackdrop.style.display = 'block';
        };
        const hideModal = () => {
            modal.style.display = 'none';
            modalBackdrop.style.display = 'none';
            pdfFrame.src = '';
        };

        const showNoteModal = (evrak) => {
            noteModalTitle.textContent = `"${evrak.konu}" Notu`;
            noteContentView.textContent = evrak.notlar;
            noteModal.style.display = 'block';
            noteModalBackdrop.style.display = 'block';
        };
        const hideNoteModal = () => {
            noteModal.style.display = 'none';
            noteModalBackdrop.style.display = 'none';
            noteContentView.textContent = '';
        };

        const renderKlasorler = () => {
            const tumKlasorler = [...new Set(evraklar.map(e => e.klasor).filter(Boolean))];
            klasorListesi.innerHTML = '';
            const createKlasorButton = (name, value) => {
                const button = document.createElement('button');
                button.textContent = name;
                button.dataset.klasor = value;
                button.className = `klasor-item px-3 py-1 text-sm font-medium rounded-full cursor-pointer transition-colors duration-200 ${seciliKlasor === value ? 'active' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`;
                return button;
            };
            klasorListesi.appendChild(createKlasorButton('Tüm Evraklar', 'all'));
            tumKlasorler.sort().forEach(klasor => klasorListesi.appendChild(createKlasorButton(klasor, klasor)));
        };
        
        const renderEvraklar = (filter = '') => {
            evrakListesiBody.innerHTML = '';
            let goruntulenecekEvraklar = evraklar;
            if (seciliKlasor !== 'all') {
                goruntulenecekEvraklar = goruntulenecekEvraklar.filter(evrak => evrak.klasor === seciliKlasor);
            }
            if (filter) {
                goruntulenecekEvraklar = goruntulenecekEvraklar.filter(evrak => {
                    const aramaTerimi = filter.toLowerCase();
                    const konuEslesmesi = evrak.konu.toLowerCase().includes(aramaTerimi);
                    const sayiEslesmesi = evrak.evrakSayisi && evrak.evrakSayisi.toLowerCase().includes(aramaTerimi);
                    return konuEslesmesi || sayiEslesmesi;
                });
            }

            if (goruntulenecekEvraklar.length === 0) {
                 evrakListesiBody.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-gray-500">Bu kritere uygun evrak bulunamadı.</td></tr>`;
                 return;
            }

            goruntulenecekEvraklar.forEach(evrak => {
                const tr = document.createElement('tr');
                const durumRenkleri = { 'Bekliyor': 'bg-blue-100 text-blue-800', 'İşlemde': 'bg-yellow-100 text-yellow-800', 'Cevaplandı': 'bg-green-100 text-green-800' };
                let noteIconHtml = '';
                if (evrak.notlar && evrak.notlar.trim() !== '') {
                    noteIconHtml = `<a href="#" class="text-yellow-500 hover:text-yellow-700 view-note" data-id="${evrak.id}" title="Notu Görüntüle"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block" viewBox="0 0 20 20" fill="currentColor"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" /><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd" /></svg></a>`;
                }
                tr.innerHTML = `<td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 flex items-center">${noteIconHtml}<span class="${noteIconHtml ? 'ml-2' : ''}">${evrak.konu}</span></td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${evrak.evrakSayisi}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(evrak.gelisTarihi)}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(evrak.sonCevapTarihi)}</td><td class="px-6 py-4 whitespace-nowrap"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${durumRenkleri[evrak.durum] || 'bg-gray-100 text-gray-800'}">${evrak.durum}</span></td><td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium"><a href="#" class="text-blue-600 hover:text-blue-900 view-pdf" data-id="${evrak.id}">Görüntüle</a><a href="#" class="text-green-600 hover:text-green-900 ml-4 edit-evrak" data-id="${evrak.id}">Düzenle</a><a href="#" class="text-red-600 hover:text-red-900 ml-4 delete-evrak" data-id="${evrak.id}">Sil</a></td>`;
                evrakListesiBody.appendChild(tr);
            });
        };

        const loadEvraklarFromGithub = async () => {
            showLoader('Evraklar GitHub\'dan yükleniyor...');
            try {
                const response = await fetch(`${apiUrl}?t=${new Date().getTime()}`, { headers: { 'Authorization': `token ${githubToken}`, 'Accept': 'application/vnd.github.v3+json' }});
                if (response.status === 404) { evraklar = []; evraklarSha = null; } 
                else if (response.ok) {
                    const data = await response.json();
                    evraklarSha = data.sha;
                    const content = b64_to_utf8(data.content);
                    if (content) { try { evraklar = JSON.parse(content); } catch (e) { alert("GitHub'daki evraklar.json dosyası bozuk."); evraklar = []; } } 
                    else { evraklar = []; }
                } else { throw new Error(`GitHub API Hatası: ${(await response.json()).message}`); }
            } catch (error) { alert(`Evraklar yüklenirken bir hata oluştu: ${error.message}`); evraklar = []; } 
            finally { renderKlasorler(); renderEvraklar(); hideLoader(); }
        };
        
        const confirmDataIsSynced = async (targetSha) => {
            let attempts = 0; const maxAttempts = 10; const delay = 1000; 
            while (attempts < maxAttempts) {
                try {
                    const response = await fetch(`${apiUrl}?t=${new Date().getTime()}`, { headers: { 'Authorization': `token ${githubToken}`, 'Accept': 'application/vnd.github.v3+json' }});
                    if (response.ok) {
                        const data = await response.json();
                        if (data.sha === targetSha) {
                            evraklarSha = data.sha;
                            evraklar = JSON.parse(b64_to_utf8(data.content)) || [];
                            return; 
                        }
                    }
                } catch (e) { console.error("Doğrulama denemesi başarısız:", e); }
                attempts++;
                await new Promise(resolve => setTimeout(resolve, delay));
            }
            console.warn("Veri senkronizasyonu zaman aşımına uğradı.");
            evraklarSha = targetSha;
        };

        const saveEvraklarToGithub = async () => {
            showLoader('Değişiklikler GitHub\'a kaydediliyor...');
            try {
                const content = utf8_to_b64(JSON.stringify(evraklar, null, 2));
                const body = { message: `Evrak listesi güncellendi - ${new Date().toISOString()}`, content: content, sha: evraklarSha };
                const response = await fetch(apiUrl, { method: 'PUT', headers: { 'Authorization': `token ${githubToken}`, 'Accept': 'application/vnd.github.v3+json' }, body: JSON.stringify(body) });
                if (response.ok) {
                    const data = await response.json();
                    showLoader('Değişiklikler kaydedildi. Senkronizasyon bekleniyor...');
                    await confirmDataIsSynced(data.content.sha);
                } else { throw new Error(`GitHub API Hatası: ${(await response.json()).message}`); }
            } catch (error) { alert(`Değişiklikler kaydedilirken bir hata oluştu: ${error.message}`); } 
            finally { renderKlasorler(); renderEvraklar(aramaInput.value); hideLoader(); }
        };

        pdfDosyaInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            try {
                const text = await pdfMetniniCikar(file);
                const sayiMatch = text.match(/Sayı\s*:\s*(.*)/i);
                if (sayiMatch) evrakSayisiInput.value = sayiMatch[1].trim();
                const konuMatch = text.match(/Konu\s*:\s*(.*)/i);
                if (konuMatch) konuInput.value = konuMatch[1].trim();
                const allDateMatchesInDoc = text.match(/(\d{2})\.(\d{2})\.(\d{4})/g);
                if (allDateMatchesInDoc) {
                    const sortedDates = [...new Set(allDateMatchesInDoc)].map(d => { const [day, month, year] = d.split('.'); return new Date(year, month - 1, day); }).sort((a, b) => b - a);
                    if (sortedDates.length > 0) gelisTarihiInput.value = sortedDates[0].toISOString().split('T')[0];
                }
                const ilgiMatch = text.match(/İlgi\s*:([\s\S]*?)(?=Konu\s*:|\n\n[A-ZÇĞİÖŞÜ])/i);
                let latestDateInIlgi = null;
                if (ilgiMatch && ilgiMatch[1]) {
                    const allDatesInIlgi = ilgiMatch[1].match(/(\d{2})\.(\d{2})\.(\d{4})/g);
                    if (allDatesInIlgi) {
                        allDatesInIlgi.forEach(d => {
                            const [day, month, year] = d.split('.');
                            const currentDate = new Date(year, month - 1, day);
                            if (!latestDateInIlgi || currentDate > latestDateInIlgi) latestDateInIlgi = currentDate;
                        });
                    }
                }
                if (latestDateInIlgi) sonCevapTarihiInput.value = latestDateInIlgi.toISOString().split('T')[0];
                seciliDosyaBase64 = await dosyayiBase64eCevir(file);
            } catch (error) { alert("PDF dosyası okunurken bir hata oluştu."); }
        });

        evrakFormu.addEventListener('submit', async (e) => {
            e.preventDefault();
            const klasorDegeri = klasorInput.value.trim();
            if (editingEvrakId) {
                const evrak = evraklar.find(ev => ev.id === editingEvrakId);
                if(evrak) Object.assign(evrak, { konu: konuInput.value, klasor: klasorDegeri, gelisTarihi: gelisTarihiInput.value, evrakSayisi: evrakSayisiInput.value, sonCevapTarihi: sonCevapTarihiInput.value, durum: durumInput.value, notlar: notlarInput.value });
            } else {
                if (!seciliDosyaBase64) { alert('Lütfen bir PDF dosyası seçin veya mobil tarayıcıyı kullanın.'); return; }
                evraklar.push({ id: Date.now(), konu: konuInput.value, klasor: klasorDegeri, gelisTarihi: gelisTarihiInput.value, evrakSayisi: evrakSayisiInput.value, sonCevapTarihi: sonCevapTarihiInput.value, durum: durumInput.value, notlar: notlarInput.value, dosyaBase64: seciliDosyaBase64 });
            }
            await saveEvraklarToGithub();
            formuTemizle();
        });
        
        iptalBtn.addEventListener('click', formuTemizle);
        aramaInput.addEventListener('input', (e) => renderEvraklar(e.target.value));
        klasorListesi.addEventListener('click', (e) => {
            if (e.target.classList.contains('klasor-item')) {
                seciliKlasor = e.target.dataset.klasor;
                renderKlasorler();
                renderEvraklar(aramaInput.value);
            }
        });

        evrakListesiBody.addEventListener('click', async (e) => {
            e.preventDefault();
            const targetLink = e.target.closest('a');
            if (!targetLink) return;
            const evrakId = parseInt(targetLink.dataset.id);
            const evrak = evraklar.find(ev => ev.id === evrakId);
            if (!evrak) return;

            if (targetLink.classList.contains('view-pdf')) showModal(evrak);
            else if (targetLink.classList.contains('view-note')) showNoteModal(evrak);
            else if (targetLink.classList.contains('delete-evrak')) {
                if (confirm('Bu evrakı silmek istediğinizden emin misiniz?')) {
                    evraklar = evraklar.filter(e => e.id !== evrakId);
                    await saveEvraklarToGithub();
                }
            } else if (targetLink.classList.contains('edit-evrak')) {
                editingEvrakId = evrak.id;
                konuInput.value = evrak.konu;
                klasorInput.value = evrak.klasor || '';
                gelisTarihiInput.value = evrak.gelisTarihi;
                evrakSayisiInput.value = evrak.evrakSayisi;
                sonCevapTarihiInput.value = evrak.sonCevapTarihi;
                durumInput.value = evrak.durum;
                notlarInput.value = evrak.notlar;
                formBasligi.textContent = 'Evrakı Düzenle';
                kaydetBtn.textContent = 'Değişiklikleri Kaydet';
                iptalBtn.classList.remove('hidden');
                pdfInputContainer.parentElement.parentElement.classList.add('hidden'); // Hide the entire row
                pdfDosyaInput.required = false;
                window.scrollTo(0, 0);
            }
        });
        
        closeModalBtn.addEventListener('click', hideModal);
        modalBackdrop.addEventListener('click', hideModal);
        closeNoteModalBtn.addEventListener('click', hideNoteModal);
        noteModalBackdrop.addEventListener('click', hideNoteModal);

        loadEvraklarFromGithub();
    });
    </script>
</body>
</html>

