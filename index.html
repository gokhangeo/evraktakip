<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evrak Takip Sistemi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PDF.js kütüphanesi -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Özel scrollbar stili */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        
        .modal-backdrop {
            display: none;
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5); z-index: 40;
        }
        .modal {
            display: none;
            position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%); z-index: 50;
        }
        #loader {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            padding: 8px;
            background-color: #3b82f6;
            color: white;
            text-align: center;
            z-index: 100;
            font-weight: 500;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="loader">İşlem yapılıyor, lütfen bekleyin...</div>

    <div class="container mx-auto p-4 md:p-8">
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-gray-700">Evrak Takip Sistemi</h1>
            <p class="text-gray-500">Gelen evraklarınızı yönetin ve takip edin.</p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Sol Taraf: Evrak Yükleme Formu -->
            <div class="lg:col-span-1 bg-white p-6 rounded-lg shadow-md h-fit">
                <h2 id="formBasligi" class="text-xl font-semibold mb-4 border-b pb-2">Yeni Evrak Ekle</h2>
                <form id="evrakFormu" class="space-y-4">
                    <div id="pdfInputContainer">
                        <label for="pdfDosya" class="block text-sm font-medium text-gray-600 mb-1">PDF Dosyası Seç</label>
                        <input type="file" id="pdfDosya" name="pdfDosya" accept=".pdf" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                    </div>
                    <div>
                        <label for="konu" class="block text-sm font-medium text-gray-600">Konu / Başlık (Otomatik)</label>
                        <input type="text" id="konu" name="konu" class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div>
                        <label for="gelisTarihi" class="block text-sm font-medium text-gray-600">Geliş Tarihi (Otomatik)</label>
                        <input type="date" id="gelisTarihi" name="gelisTarihi" class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div>
                        <label for="evrakSayisi" class="block text-sm font-medium text-gray-600">Evrak Sayısı (Otomatik)</label>
                        <input type="text" id="evrakSayisi" name="evrakSayisi" class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div>
                        <label for="sonCevapTarihi" class="block text-sm font-medium text-gray-600">Son Cevap Tarihi (Otomatik)</label>
                        <input type="date" id="sonCevapTarihi" name="sonCevapTarihi" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required>
                    </div>
                     <div>
                        <label for="durum" class="block text-sm font-medium text-gray-600">Durum</label>
                        <select id="durum" name="durum" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            <option value="Bekliyor">Bekliyor</option>
                            <option value="İşlemde">İşlemde</option>
                            <option value="Cevaplandı">Cevaplandı</option>
                        </select>
                    </div>
                    <div>
                        <label for="notlar" class="block text-sm font-medium text-gray-600">Notlar</label>
                        <textarea id="notlar" name="notlar" rows="3" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></textarea>
                    </div>
                    <div class="flex space-x-2">
                        <button type="submit" id="kaydetBtn" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-200">
                            Evrakı Kaydet
                        </button>
                        <button type="button" id="iptalBtn" class="w-full bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400 transition-colors duration-200 hidden">
                            İptal
                        </button>
                    </div>
                </form>
            </div>

            <!-- Sağ Taraf: Evrak Listesi -->
            <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md">
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <h2 class="text-xl font-semibold">Kayıtlı Evraklar</h2>
                    <input type="text" id="arama" placeholder="Konu veya evrak sayısına göre ara..." class="px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Konu</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Evrak Sayısı</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Geliş Tarihi</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Son Cevap Tarihi</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Durum</th>
                                <th scope="col" class="relative px-6 py-3">
                                    <span class="sr-only">İşlemler</span>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="evrakListesi" class="bg-white divide-y divide-gray-200">
                            <!-- Evraklar buraya eklenecek -->
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>
    
    <!-- PDF Görüntüleyici Modal -->
    <div id="pdfModalBackdrop" class="modal-backdrop"></div>
    <div id="pdfModal" class="modal bg-white rounded-lg shadow-xl w-11/12 md:w-3/4 lg:w-2/3" style="max-height: 90vh; height: 90vh;">
        <div class="p-4 border-b flex justify-between items-center">
            <h3 id="modalTitle" class="text-lg font-semibold">PDF Görüntüleyici</h3>
            <button id="closeModal" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
        </div>
        <div id="pdfViewer" class="overflow-auto h-full p-2">
            <iframe id="pdfFrame" class="w-full" style="height: calc(100% - 10px); border: none;"></iframe>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Element Referansları ---
        const evrakFormu = document.getElementById('evrakFormu');
        const pdfDosyaInput = document.getElementById('pdfDosya');
        const pdfInputContainer = document.getElementById('pdfInputContainer');
        const konuInput = document.getElementById('konu');
        const gelisTarihiInput = document.getElementById('gelisTarihi');
        const evrakSayisiInput = document.getElementById('evrakSayisi');
        const sonCevapTarihiInput = document.getElementById('sonCevapTarihi');
        const durumInput = document.getElementById('durum');
        const notlarInput = document.getElementById('notlar');
        const evrakListesiBody = document.getElementById('evrakListesi');
        const aramaInput = document.getElementById('arama');
        const loader = document.getElementById('loader');
        const kaydetBtn = document.getElementById('kaydetBtn');
        const iptalBtn = document.getElementById('iptalBtn');
        const formBasligi = document.getElementById('formBasligi');
        
        const modalBackdrop = document.getElementById('pdfModalBackdrop');
        const modal = document.getElementById('pdfModal');
        const closeModalBtn = document.getElementById('closeModal');
        const modalTitle = document.getElementById('modalTitle');
        const pdfFrame = document.getElementById('pdfFrame');

        // --- GitHub API Ayarları ---
        const p1 = 'ghp_MAuvwYTJDUiqFY5h72CZ';
        const p2 = 'eXnMKuxrCJ08sfAl';
        const githubToken = p1 + p2;
        
        const repoOwner = 'gokhangeo';
        const repoName = 'evraktakip';
        const repoPath = 'dosya/evraklar.json';
        const apiUrl = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${repoPath}`;

        // --- Uygulama Değişkenleri ---
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js`;
        let evraklar = [];
        let evraklarSha = null;
        let seciliDosyaBase64 = null;
        let editingEvrakId = null;

        // --- Yardımcı Fonksiyonlar ---
        const showLoader = (message) => { loader.textContent = message; loader.style.display = 'block'; };
        const hideLoader = () => { loader.style.display = 'none'; };
        const formatDate = (dateString) => {
            if (!dateString) return '';
            const [year, month, day] = dateString.split('-');
            return `${day}.${month}.${year}`;
        };
        
        const utf8_to_b64 = (str) => {
            return btoa(unescape(encodeURIComponent(str)));
        }
        const b64_to_utf8 = (str) => {
            return decodeURIComponent(escape(atob(str)));
        }

        const formuTemizle = () => {
            evrakFormu.reset();
            seciliDosyaBase64 = null;
            editingEvrakId = null;
            formBasligi.textContent = 'Yeni Evrak Ekle';
            kaydetBtn.textContent = 'Evrakı Kaydet';
            iptalBtn.classList.add('hidden');
            pdfDosyaInput.required = true;
            pdfInputContainer.classList.remove('hidden');
        };

        const dosyayiBase64eCevir = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        };
        const pdfMetniniCikar = async (file) => {
            const fileReader = new FileReader();
            fileReader.readAsArrayBuffer(file);
            return new Promise((resolve, reject) => {
                fileReader.onload = async () => {
                    const typedarray = new Uint8Array(fileReader.result);
                    try {
                        const pdf = await pdfjsLib.getDocument(typedarray).promise;
                        let fullText = '';
                        for (let i = 1; i <= pdf.numPages; i++) {
                            const page = await pdf.getPage(i);
                            const textContent = await page.getTextContent();
                            fullText += textContent.items.map(item => item.str).join('\n');
                        }
                        resolve(fullText);
                    } catch (error) { reject(error); }
                };
                fileReader.onerror = reject;
            });
        };
        const showModal = (evrak) => {
            modalTitle.textContent = evrak.konu;
            pdfFrame.src = evrak.dosyaBase64;
            modal.style.display = 'block';
            modalBackdrop.style.display = 'block';
        };
        const hideModal = () => {
            modal.style.display = 'none';
            modalBackdrop.style.display = 'none';
            pdfFrame.src = '';
        };


        // --- Ana Fonksiyonlar ---
        const renderEvraklar = (filter = '') => {
            evrakListesiBody.innerHTML = '';
            // DEĞİŞİKLİK: Arama hem konuya hem de evrak sayısına göre yapılıyor
            const filtrelenmisEvraklar = evraklar.filter(evrak => {
                const aramaTerimi = filter.toLowerCase();
                const konuEslesmesi = evrak.konu.toLowerCase().includes(aramaTerimi);
                const sayiEslesmesi = evrak.evrakSayisi && evrak.evrakSayisi.toLowerCase().includes(aramaTerimi);
                return konuEslesmesi || sayiEslesmesi;
            });

            if (filtrelenmisEvraklar.length === 0) {
                 evrakListesiBody.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-gray-500">Kayıtlı evrak bulunamadı.</td></tr>`;
                 return;
            }

            filtrelenmisEvraklar.forEach(evrak => {
                const tr = document.createElement('tr');
                const durumRenkleri = {
                    'Bekliyor': 'bg-blue-100 text-blue-800',
                    'İşlemde': 'bg-yellow-100 text-yellow-800',
                    'Cevaplandı': 'bg-green-100 text-green-800'
                };
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${evrak.konu}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${evrak.evrakSayisi}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(evrak.gelisTarihi)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(evrak.sonCevapTarihi)}</td>
                    <td class="px-6 py-4 whitespace-nowrap"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${durumRenkleri[evrak.durum] || 'bg-gray-100 text-gray-800'}">${evrak.durum}</span></td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <a href="#" class="text-blue-600 hover:text-blue-900 view-pdf" data-id="${evrak.id}">Görüntüle</a>
                        <a href="#" class="text-green-600 hover:text-green-900 ml-4 edit-evrak" data-id="${evrak.id}">Düzenle</a>
                        <a href="#" class="text-red-600 hover:text-red-900 ml-4 delete-evrak" data-id="${evrak.id}">Sil</a>
                    </td>
                `;
                evrakListesiBody.appendChild(tr);
            });
        };

        // --- GitHub API Fonksiyonları ---
        const loadEvraklarFromGithub = async () => {
            showLoader('Evraklar GitHub\'dan yükleniyor...');
            try {
                const response = await fetch(`${apiUrl}?t=${new Date().getTime()}`, {
                    headers: { 'Authorization': `token ${githubToken}`, 'Accept': 'application/vnd.github.v3+json' }
                });
                if (response.status === 404) {
                    evraklar = []; evraklarSha = null;
                } else if (response.ok) {
                    const data = await response.json();
                    evraklarSha = data.sha;
                    const content = b64_to_utf8(data.content);
                    if (content) {
                        try { evraklar = JSON.parse(content); } 
                        catch (e) { alert("GitHub'daki evraklar.json dosyası bozuk. Liste boş başlatılacak."); evraklar = []; }
                    } else { evraklar = []; }
                } else {
                    const errorData = await response.json();
                    throw new Error(`GitHub API Hatası: ${errorData.message}`);
                }
            } catch (error) {
                alert(`Evraklar yüklenirken bir hata oluştu: ${error.message}`); evraklar = [];
            } finally { renderEvraklar(); hideLoader(); }
        };
        
        const confirmDataIsSynced = async (targetSha) => {
            let attempts = 0; const maxAttempts = 10; const delay = 1000; 
            while (attempts < maxAttempts) {
                try {
                    const response = await fetch(`${apiUrl}?t=${new Date().getTime()}`, {
                         headers: { 'Authorization': `token ${githubToken}`, 'Accept': 'application/vnd.github.v3+json' }
                    });
                    if (response.ok) {
                        const data = await response.json();
                        if (data.sha === targetSha) {
                            evraklarSha = data.sha;
                            const content = b64_to_utf8(data.content);
                            evraklar = content ? JSON.parse(content) : [];
                            return; 
                        }
                    }
                } catch (e) { console.error("Doğrulama denemesi başarısız:", e); }
                attempts++;
                await new Promise(resolve => setTimeout(resolve, delay));
            }
            console.warn("Veri senkronizasyonu zaman aşımına uğradı.");
            evraklarSha = targetSha;
        };

        const saveEvraklarToGithub = async () => {
            showLoader('Değişiklikler GitHub\'a kaydediliyor...');
            try {
                const content = utf8_to_b64(JSON.stringify(evraklar, null, 2));
                const body = { message: `Evrak listesi güncellendi - ${new Date().toISOString()}`, content: content };
                if (evraklarSha) { body.sha = evraklarSha; }

                const response = await fetch(apiUrl, {
                    method: 'PUT',
                    headers: { 'Authorization': `token ${githubToken}`, 'Accept': 'application/vnd.github.v3+json' },
                    body: JSON.stringify(body)
                });

                if (response.ok) {
                    const data = await response.json();
                    showLoader('Değişiklikler kaydedildi. Senkronizasyon bekleniyor...');
                    await confirmDataIsSynced(data.content.sha);
                } else {
                    const errorData = await response.json();
                    throw new Error(`GitHub API Hatası: ${errorData.message}`);
                }
            } catch (error) {
                alert(`Değişiklikler kaydedilirken bir hata oluştu: ${error.message}`);
            } finally { renderEvraklar(); hideLoader(); }
        };

        // --- Olay Dinleyicileri (Event Listeners) ---
        pdfDosyaInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            try {
                const text = await pdfMetniniCikar(file);
                const sayiRegex = /Sayı\s*:\s*(.*)/i; const sayiMatch = text.match(sayiRegex);
                if (sayiMatch) { evrakSayisiInput.value = sayiMatch[1].trim(); }
                const konuRegex = /Konu\s*:\s*(.*)/i; const konuMatch = text.match(konuRegex);
                if (konuMatch) { konuInput.value = konuMatch[1].trim(); }
                const allDatesRegex = /(\d{2})\.(\d{2})\.(\d{4})/g;
                const allDateMatchesInDoc = text.match(allDatesRegex);
                if (allDateMatchesInDoc) {
                    const sortedDates = [...new Set(allDateMatchesInDoc)].map(dateStr => {
                        const [day, month, year] = dateStr.split('.').map(Number); return new Date(year, month - 1, day);
                    }).sort((a, b) => b - a);
                    if (sortedDates.length > 0) { gelisTarihiInput.value = sortedDates[0].toISOString().split('T')[0]; }
                }
                const ilgiRegex = /İlgi\s*:([\s\S]*?)(?=Konu\s*:|\n\n[A-ZÇĞİÖŞÜ])/i;
                const ilgiMatch = text.match(ilgiRegex);
                let latestDateInIlgi = null;
                if (ilgiMatch && ilgiMatch[1]) {
                    const ilgiText = ilgiMatch[1];
                    const allDatesInIlgi = ilgiText.match(allDatesRegex);
                    if (allDatesInIlgi) {
                        allDatesInIlgi.forEach(dateStr => {
                            const [day, month, year] = dateStr.split('.').map(Number);
                            const currentDate = new Date(year, month - 1, day);
                            if (!latestDateInIlgi || currentDate > latestDateInIlgi) { latestDateInIlgi = currentDate; }
                        });
                    }
                }
                if (latestDateInIlgi) { sonCevapTarihiInput.value = latestDateInIlgi.toISOString().split('T')[0]; }
                seciliDosyaBase64 = await dosyayiBase64eCevir(file);
            } catch (error) { alert("PDF dosyası okunurken bir hata oluştu."); }
        });

        evrakFormu.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (editingEvrakId) { // Düzenleme modu
                const evrak = evraklar.find(ev => ev.id === editingEvrakId);
                if(evrak){
                    evrak.konu = konuInput.value;
                    evrak.gelisTarihi = gelisTarihiInput.value;
                    evrak.evrakSayisi = evrakSayisiInput.value;
                    evrak.sonCevapTarihi = sonCevapTarihiInput.value;
                    evrak.durum = durumInput.value;
                    evrak.notlar = notlarInput.value;
                }
            } else { // Yeni kayıt modu
                if (!seciliDosyaBase64) { alert('Lütfen bir PDF dosyası seçin.'); return; }
                const yeniEvrak = {
                    id: Date.now(), konu: konuInput.value, gelisTarihi: gelisTarihiInput.value,
                    evrakSayisi: evrakSayisiInput.value, sonCevapTarihi: sonCevapTarihiInput.value,
                    durum: durumInput.value, notlar: notlarInput.value, dosyaBase64: seciliDosyaBase64
                };
                evraklar.push(yeniEvrak);
            }
            await saveEvraklarToGithub();
            formuTemizle();
        });
        
        iptalBtn.addEventListener('click', formuTemizle);
        aramaInput.addEventListener('input', (e) => { renderEvraklar(e.target.value); });

        evrakListesiBody.addEventListener('click', async (e) => {
            e.preventDefault();
            const target = e.target;
            const evrakId = parseInt(target.dataset.id);

            if (target.classList.contains('view-pdf')) {
                const evrak = evraklar.find(ev => ev.id === evrakId);
                if (evrak) showModal(evrak);
            } 
            else if (target.classList.contains('delete-evrak')) {
                if (confirm('Bu evrakı silmek istediğinizden emin misiniz?')) {
                    evraklar = evraklar.filter(e => e.id !== evrakId);
                    await saveEvraklarToGithub();
                }
            }
            else if (target.classList.contains('edit-evrak')){
                const evrak = evraklar.find(ev => ev.id === evrakId);
                if (evrak) {
                    editingEvrakId = evrak.id;
                    konuInput.value = evrak.konu;
                    gelisTarihiInput.value = evrak.gelisTarihi;
                    evrakSayisiInput.value = evrak.evrakSayisi;
                    sonCevapTarihiInput.value = evrak.sonCevapTarihi;
                    durumInput.value = evrak.durum;
                    notlarInput.value = evrak.notlar;

                    formBasligi.textContent = 'Evrakı Düzenle';
                    kaydetBtn.textContent = 'Değişiklikleri Kaydet';
                    iptalBtn.classList.remove('hidden');
                    pdfInputContainer.classList.add('hidden'); // PDF değiştirilemez
                    pdfDosyaInput.required = false;
                    window.scrollTo(0, 0); // Formu görmek için sayfanın başına git
                }
            }
        });
        
        closeModalBtn.addEventListener('click', hideModal);
        modalBackdrop.addEventListener('click', hideModal);

        // --- Başlangıç ---
        loadEvraklarFromGithub();
    });
    </script>
</body>
</html>

